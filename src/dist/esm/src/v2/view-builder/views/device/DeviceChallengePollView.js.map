{"version":3,"file":"DeviceChallengePollView.js","sources":["../../../../../../../src/v2/view-builder/views/device/DeviceChallengePollView.js"],"sourcesContent":["import { loc, createCallout } from '@okta/courage';\nimport { BaseFooter, BaseView, BaseOktaVerifyChallengeView } from '../../internals';\nimport Enums from '../../../../util/Enums';\nimport {\n  CANCEL_POLLING_ACTION,\n  IDENTIFIER_FLOW,\n  AUTHENTICATION_CANCEL_REASONS,\n} from '../../utils/Constants';\nimport Link from '../../components/Link';\nimport { doChallenge, cancelPollingWithParams } from '../../utils/ChallengeViewUtil';\nimport OktaVerifyAuthenticatorHeader from '../../components/OktaVerifyAuthenticatorHeader';\nimport { getSignOutLink } from '../../utils/LinksUtil';\n\nconst Body = BaseOktaVerifyChallengeView.extend({\n  pollingCancelAction: CANCEL_POLLING_ACTION,\n\n  getDeviceChallengePayload() {\n    return this.options.currentViewState.relatesTo.value;\n  },\n\n  doChallenge() {\n    doChallenge(this, IDENTIFIER_FLOW);\n  },\n\n  onPollingFail() {\n    BaseOktaVerifyChallengeView.prototype.onPollingFail.apply(this, arguments);\n    // When SIW receives form error, polling is already stopped\n    // SIW needs to update footer link from /poll/cancel to /idp/idx/cancel\n    const data = { label: loc('loopback.polling.cancel.link.with.form.error', 'login') };\n    this.options.appState.trigger('updateFooterLink', data);\n  },\n\n  showCustomFormErrorCallout(error) {\n    const responseJSON = error.responseJSON;\n    const options = {\n      type: 'error',\n      className: 'okta-verify-uv-callout-content',\n      subtitle: responseJSON.errorSummary,\n    };\n\n    const containsSignedNonceError = responseJSON.errorSummaryKeys &&\n      responseJSON.errorSummaryKeys.some((key) => key.includes('auth.factor.signedNonce.error'));\n    if (containsSignedNonceError) {\n      options.title = loc('user.fail.verifyIdentity', 'login');\n    }\n\n    this.showMessages(createCallout(options));\n    return true;\n  },\n});\n\nconst Footer = BaseFooter.extend({\n  initialize() {\n    this.listenTo(this.options.appState, 'updateFooterLink', this.handleUpdateFooterLink);\n    if (this.isFallbackApproach() && !this.isFallbackDelayed()) {\n      BaseFooter.prototype.initialize.apply(this, arguments);\n    } else {\n      this.backLink = this.add(Link, {\n        options: {\n          name: 'cancel-authenticator-challenge',\n          label: loc('loopback.polling.cancel.link', 'login'),\n          clickHandler: () => {\n            cancelPollingWithParams(\n              this.options.appState,\n              CANCEL_POLLING_ACTION,\n              AUTHENTICATION_CANCEL_REASONS.USER_CANCELED,\n              null\n            );\n          },\n        }\n      }).last();\n    }\n  },\n\n  handleUpdateFooterLink(data) {\n    // only update link for loopback\n    if (!this.isFallbackApproach() || this.isFallbackDelayed()) {\n      this.backLink && this.backLink.remove();\n      this.backLink = this.add(Link, {\n        options: getSignOutLink(this.options.settings, data)[0]\n      }).last();\n    } \n  },\n\n  isFallbackApproach() {\n    return [\n      Enums.CUSTOM_URI_CHALLENGE,\n      Enums.UNIVERSAL_LINK_CHALLENGE,\n      Enums.APP_LINK_CHALLENGE\n    ].includes(this.options.currentViewState.relatesTo.value.challengeMethod);\n  },\n\n  isFallbackDelayed() {\n    // only delay showing the reopen Okta Verify button for the app link approach for now\n    // until we have more data shows other approaches have the slow cold start problem of the Okta Verify app as well\n    return this.options.currentViewState.relatesTo.value.challengeMethod === Enums.APP_LINK_CHALLENGE;\n  },\n});\n\nexport default BaseView.extend({\n  Header: OktaVerifyAuthenticatorHeader,\n  Body,\n  Footer\n});\n"],"names":["Body","BaseOktaVerifyChallengeView","extend","pollingCancelAction","CANCEL_POLLING_ACTION","getDeviceChallengePayload","options","currentViewState","relatesTo","value","doChallenge","IDENTIFIER_FLOW","onPollingFail","prototype","apply","arguments","data","label","loc","appState","trigger","showCustomFormErrorCallout","error","responseJSON","type","className","subtitle","errorSummary","containsSignedNonceError","errorSummaryKeys","some","key","includes","title","showMessages","createCallout","Footer","BaseFooter","initialize","listenTo","handleUpdateFooterLink","isFallbackApproach","isFallbackDelayed","backLink","add","Link","name","clickHandler","cancelPollingWithParams","AUTHENTICATION_CANCEL_REASONS","USER_CANCELED","last","remove","getSignOutLink","settings","Enums","CUSTOM_URI_CHALLENGE","UNIVERSAL_LINK_CHALLENGE","APP_LINK_CHALLENGE","challengeMethod","BaseView","Header","OktaVerifyAuthenticatorHeader"],"mappings":"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"}